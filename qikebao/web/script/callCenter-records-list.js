var callCenter_records={totalNum:0,totalPage:0,currentPage:0,targetIds:new Array(),phones:new Array(),searchParams:{ownerUserId:"",offset:0,pageSize:_pageSize,startCreateDate:"",endCreateDate:"",customerId:"",minTime:0,phone:""},init:function(){var a=this;$('[data-tooltip="tooltip"]').tooltip({trigger:"hover"});entity.initSearchCustomerSelect("search-customerId");$("#search-startDate").datepicker({format:"yyyy-mm-dd",autoclose:true,todayBtn:"linked",clearBtn:true});$("#search-ownerUserId").select2({dropdownAutoWidth:true});$("#search-record-form").submit(function(b){a.loadRecord(1);return false});$("#recordModal").on("show.bs.modal",function(d){var c=$(d.relatedTarget);var b=c.data("record");$(this).find(".record-phone").text(b.phone);$(this).find(".record-startDate").text(b.startDate);if(b.type==1){$(this).find(".record-type").removeClass("label-info").addClass("label-success").text("去电")}else{$(this).find(".record-type").removeClass("label-success").addClass("label-info").text("来电")}$("#recordModal-audio").html("<audio src='/callCenter/record/"+encodeURIComponent(b.id)+".mp3' preload='auto' controls></audio>");$(this).find("audio").audioPlayer()}).on("hidden.bs.modal",function(b){$("#recordModal-audio").html("")});entity.initPageSizeDropMenu(function(b){a.searchParams.pageSize=b;a.loadRecord(1)});a.loadRecord(1)},loadRecord:function(a){var b=this;$("#search-loading").show();$("#item-pageNavi, #record-blank, #dropdown-menu-pageSize").hide();$("#entity-item-list .list-item").remove();b.searchParams.offset=(a-1)*b.searchParams.pageSize;b.searchParams.customerId=$("#search-customerId").val();b.searchParams.ownerUserId=$("#search-ownerUserId").val();b.searchParams.startCreateDate=$("#search-startStartDate").val();b.searchParams.endCreateDate=$("#search-endStartDate").val();b.searchParams.minTime=$("#search-minTime").val();b.searchParams.phone=$("#search-phone").val();b.currentPage=a;$.ajax({url:"/callCenter/records",type:"POST",data:b.searchParams,dataType:"json",timeout:60000,error:function(e,c,d){$("#search-loading").hide();alertify.alert("通话记录加载失败，请稍后再试")},success:function(c){$("#search-loading").hide();if(c.code<=0){alertify.alert(c.message);return}if(b.searchParams.offset==0){b.totalNum=c.items.totalNum;b.totalPage=Math.ceil(b.totalNum/b.searchParams.pageSize);if(b.totalNum==0){$("#record-blank").show();return}}b.targetIds.length=0;b.phones.length=0;$.each(c.items.records,function(d,e){b.showItem(d,e)});$("#item-pageNavi, #dropdown-menu-pageSize").show();b.loadEntitiesName();b.searchCustomers();createPageNavi(a,b.totalPage,b.totalNum,"item-pageNavi",function(d){b.loadRecord(d)})}})},showItem:function(c,d){var f=$("#record-body");var e=$("#item-clone").clone(true);e.removeClass("hide").addClass("list-item");e.find(".idx").text(c+1);if(d.type==1){e.find("span.record-type").addClass("label-success").text("去电")}else{e.find("span.record-type").addClass("label-info").text("来电")}e.find("td.record-phone").text(d.phone);e.find("td.record-startDate").text(getFormatDate(d.startDate,"YYYY-MM-DD HH:mm"));e.find("td.record-totalTime").text(Number(d.totalTime).formatTime());e.find("td.record-province").text(d.province);e.find("td.record-city").text(d.city);if(d.totalTime==0){e.find("td.record-operation").text("")}else{var b=d.fileName;if(b==""||isUndefined(b)){e.find("td.record-operation").text("")}else{e.find(".btn-record").data("record",d);e.find(".btn-download").attr("href","/callCenter/record/"+encodeURIComponent(d.id)+".mp3?download=1")}}var a=entity.getUser(_users,d.encodedUserId);e.find("td.record-user").text(a.name);if(d.encodedCustomerId==""){this.addPhone(d.phone)}else{e.find("a.record-customerName").attr("id","record-item-"+d.encodedCustomerId+"-2").attr("href",entity.getEntityUrl(d.encodedCustomerId,2));e.find("a.record-contactName").attr("id","record-item-"+d.encodedContactId+"-3").attr("href",entity.getEntityUrl(d.encodedContactId,3));this.addEntity({id:d.encodedCustomerId,type:2});this.addEntity({id:d.encodedContactId,type:3})}e.appendTo(f)},addEntity:function(a){var c=this;var b=false;$.each(c.targetIds,function(d,e){if(e.id==a.id&&e.type==a.type){b=true;return false}});if(b){return}c.targetIds.push({id:a.id,type:a.type})},addPhone:function(a){var c=this;var b=false;$.each(c.phones,function(d,e){if(a==e){b=true;return false}});if(b){return}c.phones.push(a)},loadEntitiesName:function(){var a=this;if(a.targetIds.length==0){return}$.ajax({url:"/entity/names",type:"POST",data:{targetIds:JSON.stringify(a.targetIds)},dataType:"json",timeout:60000,error:function(d,b,c){alertify.alert("加载通话记录客户信息失败，请稍后再试")},success:function(b){if(b.code<=0){alertify.alert(b.message);return}if(b.items.totalNum==0){return}$.each(b.items.names,function(c,d){$("[id='record-item-"+d.id+"-"+d.type+"']").text(d.text)})}})},searchCustomers:function(){var a=this;if(a.phones.length==0){return}$.ajax({url:"/callCenter/records/searchCustomer",type:"POST",data:{phones:a.phones.join()},dataType:"json",timeout:60000})}};$(function(){callCenter_records.init()});